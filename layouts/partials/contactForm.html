<style>
    /**Google Forms**/
    form {
        max-width: 420px;
        margin: auto;
        padding: 1em 0 1em 0;
    }

    .form {
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 2%;
    }

    .form-input {
        font-family: Helvetica, Arial, sans-serif;
        font-weight: 500;
        font-size: 18px;
        border-radius: 5px;
        line-height: 22px;
        background-color: #fff;
        transition: all 0.3s;
        padding: 13px;
        margin-bottom: 15px;
        width: 100%;
        box-sizing: border-box;
        outline: 0;
    }

    textarea {
        height: 150px;
        line-height: 150%;
        resize: vertical;
    }

    input.send-button {
        width: 100% !important;
        max-width: inherit;
        font-weight: bolder !important;
        margin: 0 auto;
        display: block;
        text-transform: none;
        padding: 0;
        font-size: 1rem;
    }

    .google-form label {
        font-size: 1rem;
        margin: inherit;
    }

    .hp-field {
        position: absolute;
        left: -9999px;
        width: 1px;
        height: 1px;
        opacity: 0;
        pointer-events: none;
    }

    @media screen and (orientation:portrait) {
        form {
            padding: 1em 1em 1em 1em;
        }
    }

    .cf-turnstile {
        display: flex;
        justify-content: center;
        margin-bottom: 1em;
    }

    .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .error-message, .thank-you {
        padding: 1em;
        margin: 1em;
        border-radius: 5px;
        text-align: center;
    }

    .error-message {
        background-color: #fee;
        color: #c33;
    }

    .thank-you {
        background-color: #efe;
        color: #3a3;
    }
</style>

<div class="form">
    <form class="doodles-font google-form" id="contactForm">

        {{/* Custom fields or default fields */}}
        {{ $fields := .fields }}
        {{ if not $fields }}
            {{/* Default fields if none provided */}}
            {{ $fields = slice
                (dict "name" "name" "label" "Name" "type" "text" "required" true)
                (dict "name" "email" "label" "Email" "type" "email" "required" true)
                (dict "name" "subject" "label" "Subject" "type" "text" "required" true)
                (dict "name" "message" "label" "Message" "type" "textarea" "rows" 5)
            }}
        {{ end }}

        {{/* Render each custom field */}}
        {{ range $fields }}
            <label for="{{ .name }}">{{ .label }}{{ if .required }}*{{ end }}</label>

            {{ if eq .type "textarea" }}
                <textarea
                    id="{{ .name }}"
                    class="form-input"
                    name="{{ .name }}"
                    {{ if .rows }}rows="{{ .rows }}"{{ else }}rows="5"{{ end }}
                    {{ if .required }}required{{ end }}
                    {{ with .placeholder }}placeholder="{{ . }}"{{ end }}
                ></textarea>
            {{ else if eq .type "select" }}
                <select
                    id="{{ .name }}"
                    class="form-input"
                    name="{{ .name }}"
                    {{ if .required }}required{{ end }}
                >
                    {{ if .placeholder }}
                        <option value="" disabled selected>{{ .placeholder }}</option>
                    {{ end }}
                    {{ range .options }}
                        <option value="{{ .value }}">{{ .label }}</option>
                    {{ end }}
                </select>
            {{ else }}
                <input
                    id="{{ .name }}"
                    type="{{ .type | default "text" }}"
                    class="form-input"
                    name="{{ .name }}"
                    {{ if .required }}required{{ end }}
                    {{ with .placeholder }}placeholder="{{ . }}"{{ end }}
                    {{ with .min }}min="{{ . }}"{{ end }}
                    {{ with .max }}max="{{ . }}"{{ end }}
                    {{ with .pattern }}pattern="{{ . }}"{{ end }}
                />
            {{ end }}
        {{ end }}

        {{/* Honeypot field (always included) */}}
        <div class="hp-field" aria-hidden="true">
            <label for="phone_number">Phone</label>
            <input type="text" name="phone_number" id="phone_number" tabindex="-1" autocomplete="off">
        </div>

        {{ with .turnstileSiteKey }}
            <div class="cf-turnstile" data-sitekey="{{ . }}" data-callback="onTurnstileSuccess"></div>
        {{ end }}
        <input class="doodles-font send-button" type="submit" value="{{ .submitText | default "Send" }}" disabled id="submitBtn" />
    </form>
</div>

{{with .workerURL}}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script type="text/javascript">
    var turnstileVerified = false;
    const WORKER_URL = "{{.}}"; 

    function onTurnstileSuccess(token) {
        turnstileVerified = true;
        document.getElementById('submitBtn').disabled = false;
    }

    function showMessage(message, isError = false) {
        let form = document.querySelector(".form");
        let msgDiv = document.createElement("div");
        msgDiv.textContent = message;
        msgDiv.classList.add(isError ? "error-message" : "thank-you");
        
        // Remove any existing messages
        let existingMsg = form.querySelector('.error-message, .thank-you');
        if (existingMsg) existingMsg.remove();
        
        form.appendChild(msgDiv);
        
        if (!isError) {
            document.getElementById('contactForm').style.display = 'none';
        }
    }

    document.getElementById('contactForm').addEventListener('submit', async function (event) {
        event.preventDefault();
        
        // Honeypot check
        var honeypotField = document.getElementById('phone_number').value;
        if (honeypotField.length > 0) {
            showMessage('Spam detected. Submission blocked.', true);
            return;
        }

        // Turnstile verification check
        if (!turnstileVerified) {
            showMessage('Please verify you are human by completing the challenge.', true);
            return;
        }

        // Disable submit button during submission
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.value = 'Sending...';

        try {
            const formData = new FormData(this);
            
            const response = await fetch(WORKER_URL, {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            if (result.success) {
                showMessage('Thank you for your submission!');
            } else {
                showMessage(result.error || 'Submission failed. Please try again.', true);
                submitBtn.disabled = false;
                submitBtn.value = 'Send';
            }
        } catch (error) {
            showMessage('Network error. Please try again.', true);
            submitBtn.disabled = false;
            submitBtn.value = 'Send';
        }
    });
</script>
{{ end }}