{{ define "main" }}
<section class="aling-center">
    <div class="inner">
        <h1 class="titlebar doodles-font">{{.Title}}</h1>
    </div>
</section>

<div class="product-list-container">
    <div class="product-list">
        {{ range .Pages }}
        <div class="product-item">
            <a href="{{ .Permalink }}" class="product-link">
                {{ if .Params.image }}
                <div class="product-image-wrapper">
                    <img src="{{ .Params.image }}" alt="{{ .Title }}" class="product-image" />
                </div>
                {{ end }}

                <div class="product-info">
                    <h2 class="product-title">{{ .Title }}</h2>

                    {{ if .Params.description }}
                    <p class="product-description">{{ .Params.description }}</p>
                    {{ end }}

                    {{ if .Params.price }}
                    <p class="product-price">${{ .Params.price }}</p>
                    {{ end }}
                </div>
            </a>

            <!-- Add to Cart Button -->
            {{ if and .Params.productId .Params.priceId }}
            <button
                class="add-to-cart-btn"
                data-product-id="{{ .Params.productId }}"
                data-price-id="{{ .Params.priceId }}"
                data-name="{{ .Title }}"
                data-price="{{ mul .Params.price 100 }}"
                {{ if .Params.image }}data-image="{{ .Params.image }}"{{ end }}
            >
                Add to Cart
            </button>
            {{ else }}
            <!-- Fallback to old Buy Now if Stripe IDs not configured -->
            <button class="checkout-button-legacy" data-title="{{ .Title }}" data-price="{{ .Params.price }}">
                Buy Now (Legacy)
            </button>
            {{ end }}
        </div>
        {{ end }}
    </div>
</div>

<style>
.product-list-container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.product-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

/* Desktop: 3+ columns */
@media (min-width: 1024px) {
    .product-list {
        grid-template-columns: repeat(3, 1fr);
        gap: 2.5rem;
    }
}

/* Tablet: 2 columns */
@media (min-width: 640px) and (max-width: 1023px) {
    .product-list {
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
    }
}

/* Mobile: 1 column, scrollable */
@media (max-width: 639px) {
    .product-list-container {
        padding: 0 1rem;
    }

    .product-list {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
}

.product-item {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
}

.product-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.product-link {
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    flex: 1;
}

.product-image-wrapper {
    width: 100%;
    aspect-ratio: 1;
    overflow: hidden;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
}

.product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
}

.product-item:hover .product-image {
    transform: scale(1.05);
}

.product-info {
    padding: 1.25rem;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.product-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 0.75rem 0;
    color: #333;
    line-height: 1.3;
}

.product-description {
    font-size: 0.9rem;
    color: #666;
    margin: 0 0 1rem 0;
    line-height: 1.5;
    flex: 1;
}

.product-price {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c5f2d;
    margin: 0;
}

.add-to-cart-btn,
.checkout-button-legacy {
    width: 100%;
    background-color: #2c5f2d;
    color: white;
    border: none;
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
    border-radius: 0;
}

.add-to-cart-btn:hover,
.checkout-button-legacy:hover {
    background-color: #1e4620;
}

.add-to-cart-btn:active,
.checkout-button-legacy:active {
    transform: scale(0.98);
}

.checkout-button-legacy {
    background-color: #888;
}

.checkout-button-legacy:hover {
    background-color: #666;
}

/* Visual feedback when adding to cart */
.add-to-cart-btn.added {
    background-color: #4caf50;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.product-item {
    animation: fadeIn 0.3s ease-out;
}
</style>

<script>
    // Add to Cart functionality
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const productId = this.dataset.productId;
            const priceId = this.dataset.priceId;
            const name = this.dataset.name;
            const price = parseInt(this.dataset.price);
            const image = this.dataset.image || null;

            if (window.shoppingCart) {
                window.shoppingCart.addItem(productId, priceId, name, price, 1, image);

                // Visual feedback
                this.textContent = 'Added!';
                this.classList.add('added');

                setTimeout(() => {
                    this.textContent = 'Add to Cart';
                    this.classList.remove('added');
                }, 2000);
            } else {
                alert('Cart is loading, please try again in a moment');
            }
        });
    });

    // Legacy Buy Now (for products without Stripe IDs)
    if (document.querySelectorAll('.checkout-button-legacy').length > 0) {
        const stripe = Stripe('pk_test_51NYiz2GWnDaMybgFD1k2fJbIF0VCuqn7VZoaVRCmbHEqnwgW0ZtFvpxNecZLJhhDnkQkYQ4erWZGd589Df7jx3Cw00oANyO28m');

        document.querySelectorAll('.checkout-button-legacy').forEach(button => {
            button.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();

                const title = this.dataset.title;
                const price = parseFloat(this.dataset.price);

                try {
                    const response = await fetch('/.netlify/functions/create-checkout-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, price })
                    });

                    const { id } = await response.json();
                    await stripe.redirectToCheckout({ sessionId: id });
                } catch (error) {
                    console.error('Checkout error:', error);
                    alert('Failed to initiate checkout');
                }
            });
        });
    }
</script>
{{end}}
